# üîê CONFIGURATION MICROSOFT OAUTH (UM6P Login)

## Pourquoi Microsoft OAuth ?
- ‚úÖ Les √©tudiants utilisent d√©j√† leurs comptes UM6P (Outlook)
- ‚úÖ Pas besoin de g√©rer les mots de passe
- ‚úÖ V√©rification automatique du domaine @um6p.ma
- ‚úÖ Authentification s√©curis√©e par Microsoft

---

## √âTAPE 1: Cr√©er une Application Azure AD

### 1. Aller sur Azure Portal
https://portal.azure.com/

### 2. Cr√©er une App Registration
1. Recherchez "**App registrations**" dans la barre de recherche
2. Cliquez "**New registration**"
3. Remplissez:
   - **Name**: `INF Platform 2.0`
   - **Supported account types**: `Accounts in any organizational directory (Any Azure AD directory - Multitenant)`
   - **Redirect URI**: 
     - Type: `Web`
     - URL: `https://YOUR_SUPABASE_PROJECT_REF.supabase.co/auth/v1/callback`
     - (Remplacez YOUR_SUPABASE_PROJECT_REF par votre vrai project ref)

4. Cliquez "**Register**"

### 3. R√©cup√©rer les credentials
Apr√®s cr√©ation, vous verrez:
- **Application (client) ID** - Copiez-le
- **Directory (tenant) ID** - Copiez-le

### 4. Cr√©er un Client Secret
1. Dans le menu gauche: **Certificates & secrets**
2. Cliquez "**New client secret**"
3. Description: `INF Platform`
4. Expires: `24 months` (ou plus)
5. Cliquez "**Add**"
6. **‚ö†Ô∏è IMPORTANT**: Copiez la **Value** IMM√âDIATEMENT (elle ne sera plus visible)

---

## √âTAPE 2: Configurer Supabase

1. Allez dans votre projet Supabase
2. **Authentication** ‚Üí **Providers** ‚Üí **Azure**
3. Activez "Azure enabled"
4. Remplissez:
   - **Azure Client ID**: (l'Application ID r√©cup√©r√©)
   - **Azure Secret**: (le Client Secret Value r√©cup√©r√©)
   - **Azure Tenant**: `common` (pour multi-tenant) OU votre Tenant ID si UM6P est single-tenant

5. Cliquez "**Save**"

---

## √âTAPE 3: Ajouter la Liste Blanche des Emails

Dans Supabase **SQL Editor**, ex√©cutez:

```sql
-- Ex√©cuter la migration d'abord
-- (Copier le contenu de supabase/migrations/20251101000004_email_validation.sql)

-- Ensuite ajouter les emails autoris√©s (exemple)
INSERT INTO allowed_student_emails (email, student_name, student_number) VALUES
('ahmed.benali@um6p.ma', 'Ahmed Benali', 'INF2023001'),
('sara.idrissi@um6p.ma', 'Sara Idrissi', 'INF2023002'),
('youssef.tazi@um6p.ma', 'Youssef Tazi', 'INF2023003');
-- ... ajouter tous les emails

-- OU importer depuis un CSV:
SELECT import_allowed_emails('
ahmed.benali@um6p.ma
sara.idrissi@um6p.ma
youssef.tazi@um6p.ma
');
```

---

## √âTAPE 4: Tester

1. Allez sur http://localhost:3000
2. Vous verrez les offres (sans login)
3. Cliquez "Student Login"
4. Cliquez "Sign in with UM6P Account"
5. Vous serez redirig√© vers Microsoft
6. Connectez-vous avec un compte @um6p.ma
7. Si l'email est dans la liste blanche ‚Üí acc√®s accord√©
8. Sinon ‚Üí erreur "not authorized"

---

## ALTERNATIVE: Import massif d'emails

### Option 1: Via fichier CSV
Cr√©ez un fichier `students.csv`:
```
email
prenom1.nom1@um6p.ma
prenom2.nom2@um6p.ma
prenom3.nom3@um6p.ma
```

Puis en SQL:
```sql
SELECT import_allowed_emails('
prenom1.nom1@um6p.ma
prenom2.nom2@um6p.ma
prenom3.nom3@um6p.ma
');
```

### Option 2: Via interface admin (√† cr√©er)
Cr√©er une page `/admin/students` avec upload CSV.

---

## üîí S√âCURIT√â

### Ce qui est valid√©:
1. ‚úÖ Email doit finir par `@um6p.ma`
2. ‚úÖ Email doit √™tre dans `allowed_student_emails`
3. ‚úÖ Validation au signup ET au login OAuth
4. ‚úÖ Trigger PostgreSQL bloque les insertions non autoris√©es

### Gestion des rejets:
- Si email non @um6p.ma ‚Üí Rejet imm√©diat
- Si email @um6p.ma mais pas dans la liste ‚Üí Message: "Contactez l'administration"

---

## üìù NOTES

- **Single Sign-On**: Les √©tudiants utilisent leur session Outlook existante
- **Pas de v√©rification email**: Microsoft g√®re d√©j√† √ßa
- **First login**: Le profil est cr√©√© automatiquement
- **Liste dynamique**: Les admins peuvent ajouter/retirer des emails en temps r√©el

---

## ‚ùì TROUBLESHOOTING

**Erreur: "Redirect URI mismatch"**
‚Üí V√©rifiez que l'URL de callback dans Azure correspond exactement √† celle de Supabase

**Erreur: "Email not authorized"**
‚Üí L'email n'est pas dans `allowed_student_emails` - ajoutez-le

**Login marche mais pas de profil**
‚Üí V√©rifiez que le callback cr√©e bien le profil (voir `/app/auth/callback/route.ts`)

**Microsoft demande admin consent**
‚Üí Normal pour certaines organisations - contactez IT UM6P
