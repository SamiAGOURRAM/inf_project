# ðŸš€ SUPABASE CLOUD SETUP - QUICK START

## Step 1: Create Supabase Project (5 minutes)

1. Go to https://supabase.com/dashboard
2. Click "New Project"
3. Fill in:
   - **Name**: INF Platform 2.0
   - **Database Password**: (choose a strong password - SAVE IT!)
   - **Region**: Choose closest to your users
   - **Pricing Plan**: Free tier is sufficient for testing
4. Click "Create new project"
5. Wait 2-3 minutes for the project to be created

## Step 2: Get Your Credentials (1 minute)

1. In your Supabase project dashboard
2. Click on the **Settings** icon (âš™ï¸) in the sidebar
3. Go to **API** section
4. You'll see:
   - **Project URL** - Copy this
   - **Project API keys** > **anon public** - Copy this

## Step 3: Configure Frontend (1 minute)

1. Open `/frontend/.env.local`
2. Replace with your values:

```env
NEXT_PUBLIC_SUPABASE_URL=https://YOUR_PROJECT_REF.supabase.co
NEXT_PUBLIC_SUPABASE_ANON_KEY=YOUR_ANON_KEY_HERE
```

## Step 4: Run Migrations (5 minutes)

1. In Supabase dashboard, click **SQL Editor** in sidebar
2. Click **New query**
3. Copy and paste **MIGRATION 1** (see below)
4. Click **Run** (or press Ctrl/Cmd + Enter)
5. Wait for success message âœ…
6. Repeat for **MIGRATION 2** and **MIGRATION 3**

---

## MIGRATION 1: Initial Schema

Copy this entire code block into SQL Editor:

```sql
-- =====================================================
-- INF Platform 2.0 - Initial Schema
-- =====================================================

-- Enable required extensions
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";

-- =====================================================
-- ENUMS
-- =====================================================

CREATE TYPE user_role AS ENUM ('student', 'company', 'admin');
CREATE TYPE booking_status AS ENUM ('confirmed', 'cancelled');
CREATE TYPE interest_tag AS ENUM ('OpÃ©rationnel', 'Administratif');

-- =====================================================
-- TABLES
-- =====================================================

-- 1. Profiles (extends Supabase auth.users)
CREATE TABLE profiles (
    id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
    email TEXT NOT NULL UNIQUE,
    full_name TEXT NOT NULL,
    role user_role NOT NULL,
    is_deprioritized BOOLEAN NOT NULL DEFAULT false,
    phone TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 2. Companies
CREATE TABLE companies (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    profile_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    company_name TEXT NOT NULL,
    description TEXT,
    logo_url TEXT,
    website TEXT,
    industry TEXT,
    employee_count TEXT,
    is_verified BOOLEAN NOT NULL DEFAULT false,
    verified_at TIMESTAMPTZ,
    verified_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 3. Offers
CREATE TABLE offers (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    title TEXT NOT NULL,
    description TEXT NOT NULL,
    interest_tag interest_tag NOT NULL,
    requirements TEXT,
    duration_months INTEGER,
    location TEXT,
    remote_possible BOOLEAN DEFAULT false,
    paid BOOLEAN DEFAULT true,
    salary_range TEXT,
    skills_required TEXT[],
    benefits TEXT,
    is_active BOOLEAN NOT NULL DEFAULT true,
    view_count INTEGER NOT NULL DEFAULT 0,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT valid_duration CHECK (duration_months IS NULL OR (duration_months >= 1 AND duration_months <= 12))
);

-- 4. Event Configuration (Single row)
CREATE TABLE event_config (
    id INTEGER PRIMARY KEY DEFAULT 1,
    event_date DATE NOT NULL,
    phase1_start TIMESTAMPTZ NOT NULL,
    phase1_end TIMESTAMPTZ NOT NULL,
    phase2_start TIMESTAMPTZ NOT NULL,
    phase2_end TIMESTAMPTZ NOT NULL,
    current_phase INTEGER NOT NULL DEFAULT 0 CHECK (current_phase IN (0, 1, 2)),
    phase1_booking_limit INTEGER NOT NULL DEFAULT 3,
    phase2_booking_limit INTEGER NOT NULL DEFAULT 6,
    slot_duration_minutes INTEGER NOT NULL DEFAULT 10,
    slot_buffer_minutes INTEGER NOT NULL DEFAULT 5,
    slot_capacity INTEGER NOT NULL DEFAULT 2,
    event_start_time TIME NOT NULL DEFAULT '09:00:00',
    event_end_time TIME NOT NULL DEFAULT '17:00:00',
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT single_config_row CHECK (id = 1)
);

-- 5. Event Slots
CREATE TABLE event_slots (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    company_id UUID NOT NULL REFERENCES companies(id) ON DELETE CASCADE,
    offer_id UUID NOT NULL REFERENCES offers(id) ON DELETE CASCADE,
    start_time TIMESTAMPTZ NOT NULL,
    end_time TIMESTAMPTZ NOT NULL,
    capacity INTEGER NOT NULL DEFAULT 2,
    location TEXT,
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    CONSTRAINT valid_time_range CHECK (end_time > start_time)
);

-- 6. Bookings
CREATE TABLE bookings (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    student_id UUID NOT NULL REFERENCES profiles(id) ON DELETE CASCADE,
    slot_id UUID NOT NULL REFERENCES event_slots(id) ON DELETE CASCADE,
    status booking_status NOT NULL DEFAULT 'confirmed',
    booking_phase INTEGER NOT NULL CHECK (booking_phase IN (1, 2)),
    notes TEXT,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    cancelled_at TIMESTAMPTZ,
    cancellation_reason TEXT,
    CONSTRAINT unique_student_slot UNIQUE (student_id, slot_id)
);

-- 7. Booking Attempts (Audit trail)
CREATE TABLE booking_attempts (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    student_id UUID REFERENCES profiles(id) ON DELETE SET NULL,
    slot_id UUID REFERENCES event_slots(id) ON DELETE SET NULL,
    success BOOLEAN NOT NULL,
    error_code TEXT,
    error_message TEXT,
    ip_address INET,
    user_agent TEXT,
    response_time_ms INTEGER,
    created_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- =====================================================
-- INDEXES (Performance)
-- =====================================================

CREATE INDEX idx_profiles_role ON profiles(role);
CREATE INDEX idx_profiles_email ON profiles(email);
CREATE INDEX idx_profiles_deprioritized ON profiles(is_deprioritized) WHERE is_deprioritized = true;

CREATE INDEX idx_companies_profile ON companies(profile_id);
CREATE INDEX idx_companies_verified ON companies(is_verified) WHERE is_verified = true;

CREATE INDEX idx_offers_company ON offers(company_id);
CREATE INDEX idx_offers_tag ON offers(interest_tag);
CREATE INDEX idx_offers_active ON offers(is_active) WHERE is_active = true;

CREATE INDEX idx_slots_company ON event_slots(company_id);
CREATE INDEX idx_slots_offer ON event_slots(offer_id);
CREATE INDEX idx_slots_time ON event_slots(start_time, end_time);

CREATE INDEX idx_bookings_student ON bookings(student_id);
CREATE INDEX idx_bookings_slot ON bookings(slot_id);
CREATE INDEX idx_bookings_student_active ON bookings(student_id) WHERE status = 'confirmed';
CREATE INDEX idx_bookings_slot_active ON bookings(slot_id) WHERE status = 'confirmed';
CREATE INDEX idx_bookings_phase ON bookings(booking_phase);

CREATE INDEX idx_booking_attempts_student ON booking_attempts(student_id);
CREATE INDEX idx_booking_attempts_slot ON booking_attempts(slot_id);
CREATE INDEX idx_booking_attempts_created ON booking_attempts(created_at DESC);
CREATE INDEX idx_booking_attempts_success ON booking_attempts(success);

-- =====================================================
-- ROW LEVEL SECURITY (RLS)
-- =====================================================

ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE companies ENABLE ROW LEVEL SECURITY;
ALTER TABLE offers ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_config ENABLE ROW LEVEL SECURITY;
ALTER TABLE event_slots ENABLE ROW LEVEL SECURITY;
ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
ALTER TABLE booking_attempts ENABLE ROW LEVEL SECURITY;

-- Profiles: Users can read all, update only their own
CREATE POLICY "Profiles are viewable by everyone" ON profiles FOR SELECT USING (true);
CREATE POLICY "Users can update own profile" ON profiles FOR UPDATE USING (auth.uid() = id);
CREATE POLICY "Users can insert own profile" ON profiles FOR INSERT WITH CHECK (auth.uid() = id);

-- Companies: Viewable by all, manageable by owner
CREATE POLICY "Companies are viewable by everyone" ON companies FOR SELECT USING (true);
CREATE POLICY "Company owners can update their company" ON companies FOR UPDATE USING (profile_id = auth.uid());
CREATE POLICY "Company owners can insert their company" ON companies FOR INSERT WITH CHECK (profile_id = auth.uid());

-- Offers: Viewable by all, manageable by company
CREATE POLICY "Offers are viewable by everyone" ON offers FOR SELECT USING (true);
CREATE POLICY "Company can manage their offers" ON offers FOR ALL USING (
    company_id IN (SELECT id FROM companies WHERE profile_id = auth.uid())
);

-- Event Config: Readable by all
CREATE POLICY "Event config is viewable by everyone" ON event_config FOR SELECT USING (true);

-- Event Slots: Viewable by all
CREATE POLICY "Event slots are viewable by everyone" ON event_slots FOR SELECT USING (true);

-- Bookings: Students see their own, companies see their slots' bookings
CREATE POLICY "Students can view their bookings" ON bookings FOR SELECT USING (student_id = auth.uid());
CREATE POLICY "Companies can view bookings for their slots" ON bookings FOR SELECT USING (
    slot_id IN (SELECT id FROM event_slots WHERE company_id IN (SELECT id FROM companies WHERE profile_id = auth.uid()))
);

-- Booking Attempts: Students can view their own
CREATE POLICY "Users can view their booking attempts" ON booking_attempts FOR SELECT USING (student_id = auth.uid());

-- =====================================================
-- TRIGGERS
-- =====================================================

-- Auto-update updated_at timestamps
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER update_profiles_updated_at BEFORE UPDATE ON profiles
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_companies_updated_at BEFORE UPDATE ON companies
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_offers_updated_at BEFORE UPDATE ON offers
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();

CREATE TRIGGER update_event_config_updated_at BEFORE UPDATE ON event_config
    FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

Click **Run** âœ…

---

## MIGRATION 2: Core Functions

Copy this into SQL Editor and run:

```sql
-- Copy the entire content from /supabase/migrations/20251101000002_core_functions.sql
```

(File is too long - use the file directly from the migrations folder)

---

## MIGRATION 3: Seed Data (OPTIONAL - for testing)

```sql
-- Insert default event configuration
INSERT INTO event_config (
    id,
    event_date,
    phase1_start,
    phase1_end,
    phase2_start,
    phase2_end,
    current_phase,
    phase1_booking_limit,
    phase2_booking_limit
) VALUES (
    1,
    '2025-11-20',
    '2025-11-13 08:00:00+00',
    '2025-11-17 23:59:59+00',
    '2025-11-18 08:00:00+00',
    '2025-11-20 17:00:00+00',
    0,  -- Not started yet
    3,  -- Phase 1 limit
    6   -- Phase 2 limit
);
```

---

## Step 5: Test the Setup (2 minutes)

1. Start the Next.js dev server:
   ```bash
   cd frontend
   npm run dev
   ```

2. Open http://localhost:3000
3. Try to create an account
4. Check Supabase dashboard > Authentication to see the new user

---

## âœ… YOU'RE DONE!

Your INF Platform 2.0 is now running with Supabase Cloud!

### What You Have Now:
- âœ… Supabase Cloud database with all tables
- âœ… Row Level Security (RLS) enabled
- âœ… All business logic functions
- âœ… Next.js frontend connected

### Next Steps:
1. Create an admin account manually in Supabase:
   - Go to Authentication > Users
   - Click on your user
   - Go to SQL Editor and run:
     ```sql
     UPDATE profiles SET role = 'admin' WHERE email = 'your@email.com';
     ```

2. Test the flows:
   - Student signup with/without "deprioritized" flag
   - Company signup
   - Admin verification of companies

---

## ðŸ› Troubleshooting

### Error: "Invalid supabaseUrl"
- Check `.env.local` has correct URL (should start with `https://`)
- Restart `npm run dev` after changing `.env.local`

### Error: "relation does not exist"
- Migrations not run yet - go to SQL Editor and run migrations

### Can't login after signup
- Check email for verification link
- Or disable email confirmation in Supabase:
  - Authentication > Settings > Email Auth > Disable "Enable email confirmations"
